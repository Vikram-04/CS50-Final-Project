{% extends "layout.html" %} {% block title %} Habit Tracker{% endblock %}
{%block body %}

<h1 class="container pt-4 pb-2 text-center">HABIT TRACKER</h1>
<div class="habit-form-container">
  <form action="/home" method="post" class="habit-form mx-auto">
    <div class="form-group">
      <input
        class="form-control"
        type="text"
        placeholder="Habit"
        autocomplete="off"
        name="habit"
      />
    </div>
    <div class="form-group">
      <button class="btn btn-primary">Add Habit</button>
    </div>
  </form>
</div>
<div class="habit-container px-3 py-3 mx-3">
  <div class="nav-buttons p-3">
    <form method="get" action="/home">
      {% set prev_month = date.month - 1 if date.month > 1 else 12 %} {% set
      prev_year = date.year if date.month > 1 else date.year - 1 %}
      <input
        type="hidden"
        name="month"
        value="{{ prev_year }}-{{ '%02d' % prev_month }}"
      />
      <button type="submit" class="btn btn-secondary"><</button>
    </form>
    <div
      class="container-fluid text-center"
      style="font-size: xx-large; background-color: aliceblue"
    >
      {{ month_name }} - {{ date.year }}
    </div>
    <form method="get" action="/home">
      {% set next_month = 1 if date.month == 12 else date.month + 1 %} {% set
      next_year = date.year + 1 if date.month == 12 else date.year %}
      <input
        type="hidden"
        name="month"
        value="{{ next_year }}-{{ '%02d' % next_month }}"
      />
      <button type="submit" class="btn btn-secondary">></button>
    </form>
  </div>
  <table id="habit-grid">
    <thead>
      <tr>
        <th scope="col" style="background-color: aliceblue">Habit</th>
        {% for day in range(1, days_in_month + 1) %}
        <th scope="col">{{ day }}</th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      {% for habit in habits %}
      <tr>
        <th scope="row" class="row-head">
          {{ habit.habit }}
          <button
            class="del-btn"
            data-habit-id="{{ habit.id }}"
            data-del-date="{{ date }}"
          >
            ðŸ—‘
          </button>
        </th>
        {% for date in dates %} {% set key = (habit.id, date)%} {% if key in
        logs_dict %} {% set done = logs_dict[key][0] %} {% else %} {% set done =
        None %} {% endif %} {% if done == True %}
        <td
          class="habit-cell done"
          data-habit-id="{{ habit.id }}"
          data-date="{{ date }}"
        ></td>
        {% else %}
        <td
          class="habit-cell"
          data-habit-id="{{ habit.id }}"
          data-date="{{ date }}"
        ></td>
        {% endif %} {% endfor %}
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
  function isSameOrBefore(d1, d2) {
    return d1.setHours(0, 0, 0, 0) <= d2.setHours(0, 0, 0, 0);
  }
  document.querySelectorAll(".habit-cell").forEach((cell) => {
    cell.addEventListener("click", () => {
      const habitId = cell.dataset.habitId;
      const dateStr = cell.dataset.date;
      const cellDate = new Date(dateStr);
      const today = new Date();

      // Only allow toggling for today or earlier
      if (!isSameOrBefore(cellDate, today)) return;

      fetch("/toggle_habit", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ habit_id: habitId, date: dateStr }),
      })
        .then((res) => res.json())
        .then((data) => {
          if (data.done) {
            cell.classList.add("done");
          } else {
            cell.classList.remove("done");
          }
        });
    });
  });
  document.querySelectorAll(".del-btn").forEach((btn) => {
    btn.addEventListener("click", () => {
      const habitId = btn.dataset.habitId;
      const dateStr = btn.dataset.delDate;

      fetch("/delete-habit", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ habit_id: habitId, date: dateStr }),
      })
        .then((res) => res.json())
        .then((data) => {
          if (data.success) {
            btn.closest("tr").remove();
          }
        });
    });
  });
</script>

{% endblock %}
