{% extends "layout.html" %} {% block title %} Habit Tracker{% endblock %}
{%block body %}

<div class="container-homepage">
  <p>HABIT TRACKER</p>
  <p>{{ month_name }} - {{ date.year }}</p>
</div>
<div class="nav-buttons">
  <form method="get" action="/home" class="mb-3">
    {% set prev_month = date.month - 1 if date.month > 1 else 12 %} {% set
    prev_year = date.year if date.month > 1 else date.year - 1 %}
    <input
      type="hidden"
      name="month"
      value="{{ prev_year }}-{{ '%02d' % prev_month }}"
    />
    <button type="submit" class="btn btn-secondary"><</button>
  </form>
  <form method="get" action="/home" class="mb-3">
    {% set next_month = 1 if date.month == 12 else date.month + 1 %} {% set
    next_year = date.year + 1 if date.month == 12 else date.year %}
    <input
      type="hidden"
      name="month"
      value="{{ next_year }}-{{ '%02d' % next_month }}"
    />
    <button type="submit" class="btn btn-secondary">></button>
  </form>
</div>
<table id="habit-grid" class="table table-striped table-hover table-bordered">
  <thead class="thead-dark">
    <tr>
      <th scope="col">Habit</th>
      {% for day in range(1, days_in_month + 1) %}
      <th scope="col">{{ day }}</th>
      {% endfor %}
    </tr>
  </thead>
  <tbody>
    {% for habit in habits %}
    <tr>
      <th scope="row" class="row-head">
        {{ habit.habit }}
        <button
          class="del-btn btn btn-primary"
          data-habit-id="{{ habit.id }}"
          data-del-date="{{ date }}"
        >
          ␡
        </button>
      </th>
      {% for date in dates %} {% set key = (habit.id, date)%} {% if key in
      logs_dict %} {% set done = logs_dict[key][0] %} {% else %} {% set done =
      None %} {% endif %}

      <td
        class="habit-cell"
        id="cell"
        data-habit-id="{{ habit.id }}"
        data-date="{{ date }}"
      >
        {% if done == True %} ✅ {% elif done == False %} ❌ {% else %} - {%
        endif %}
      </td>
      {% endfor %}
    </tr>
    {% endfor %}
  </tbody>
</table>

<form action="/home" method="post" class="form-container mx-auto">
  <div class="form-group"><h5>Add new habit</h5></div>
  <div class="form-group">
    <input
      class="form-control"
      type="text"
      placeholder="Habit"
      autocomplete="off"
      name="habit"
    />
  </div>
  <div class="form-group">
    <button class="btn btn-primary">Add Habit</button>
  </div>
</form>

<script>
  function isSameOrBefore(d1, d2) {
    return d1.setHours(0, 0, 0, 0) <= d2.setHours(0, 0, 0, 0);
  }
  document.querySelectorAll(".habit-cell").forEach((cell) => {
    cell.addEventListener("click", () => {
      const habitId = cell.dataset.habitId;
      const dateStr = cell.dataset.date;
      const cellDate = new Date(dateStr);
      const today = new Date();

      // Only allow toggling for today or earlier
      if (!isSameOrBefore(cellDate, today)) return;

      fetch("/toggle_habit", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ habit_id: habitId, date: dateStr }),
      })
        .then((res) => res.json())
        .then((data) => {
          cell.innerText = data.done ? "✅" : "❌";
        });
    });
  });
  document.querySelectorAll(".del-btn").forEach((btn) => {
    btn.addEventListener("click", () => {
      const habitId = btn.dataset.habitId;
      const dateStr = btn.dataset.delDate;

      fetch("/delete-habit", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ habit_id: habitId, date: dateStr }),
      })
        .then((res) => res.json())
        .then((data) => {
          if (data.success) {
            btn.closest("tr").remove();
          }
        });
    });
  });
</script>

{% endblock %}
